<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib&#x2F;adapters&#x2F;db.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/core.html">core</a></li>
            
                <li><a href="..&#x2F;classes/db.html">db</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/core.html">core</a></li>
            
                <li><a href="..&#x2F;modules/db.html">db</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib&#x2F;adapters&#x2F;db.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
 * Database adapter.
 * 
 * This adapter acts as a proxy within your application and the ORM module chosen.
 * Currently it only supports Sequelize - http:&#x2F;&#x2F;www.sequelizejs.com&#x2F; - but more 
 * will be added in the future.
 * 
 * Supported addapters&#x27; strings: sequelize
 * 
 * @module  db
 * @author Nicolas Iglesias &lt;nicolas@clevertech.biz&gt;
 *&#x2F;
var seq = require(&#x27;sequelize&#x27;)
,path = require(&#x27;path&#x27;)
,config = require(path.resolve(__dirname+&#x27;&#x2F;..&#x2F;..&#x2F;src&#x2F;config&#x2F;main&#x27;)).main.db
,inflector = require(&#x27;inflector&#x27;)
,lib = require(path.resolve(__dirname+&#x27;&#x2F;..&#x2F;&#x27;))
,_adapter = null, _instance = null;

&#x2F;**
 * @class   db
 *&#x2F;
module.exports = function(){
    &#x2F;**
     * Will make available all the relationships for the final model object.
     * 
     * @method  _defineRelationsGettersAndSetters
     * @private
     * @param   {Object}    The ORM model&#x27;s instance.
     * @param   {Object}    The final model&#x27;s instance.
     *&#x2F;
    var _defineRelationsGettersAndSetters = function(_with, localModel, that){
        var _this = that;
        
        switch(config.adapter){
            case &#x27;sequelize&#x27;:
                if(typeof _with !== &#x27;undefined&#x27; &amp;&amp; _with !== null)
                    try{
                        _with.forEach(function(rel){
                            var a = rel.split(&#x27;.&#x27;), c=0;
                            a.forEach(function(r){
                                var relModel = localModel._ormModel[r];

                                localModel[r] = (function(){
                                    var w = typeof a[c+1]!==&#x27;undefined&#x27; ? a[c+1]:null;
                                    return _this.getLocalModelFromORM(relModel, lib.core.models[r], w)
                                })()
                                c++;
                            });
                        })
                    }catch(e){
                        console.trace(r)
                    }
                break;
        }
    }
        
    return {
        &#x2F;**
         * The initialization will instantiate the ORM, by providing database parameters 
         * and doing the appropiate startup sequence for the chosen ORM module.
         * This method must be run before any other method in this module.
         * 
         * @method  initialize
         *&#x2F;
        initialize : function(){
            if(!config.adapter)
                config.adapter = &#x27;sequelize&#x27;;

            switch(config.adapter){
                &#x2F;&#x2F; initialize sequelize.
                case &#x27;sequelize&#x27;:
                    _adapter = config.adapter;
                    _instance = new seq(config.database, config.username, config.password, {
                        dialect: config.driver,
                        port:config.port,
                        omitNull:true,
                        define: {
                            underscored: true,
                            freezeTableName: false,
                            charset: &#x27;utf8&#x27;,
                            collate: &#x27;utf8_general_ci&#x27;,
                            timestamps: false,
                            instanceMethods:{},
                            classMethods:{}
                        }
                    });
                    return _instance;
                    break;
            }
    
            return null;
        },
        &#x2F;**
         * Get new ORM model&#x27;s instance.
         * This method will return a new instance of the given model in its ORM&#x27;s specific format, 
         * by using the appropiate method defined by the chosen ORM module.
         * 
         * @param   {String}    Name of model to import.
         * @method loadORMModel
         * @return  {Object}    ORM model.
         *&#x2F;
        loadORMModel : function(modelName){
            if(!config.adapter &amp;&amp; typeof _instance !== &#x27;object&#x27;)
                console.trace(&#x27;db adapter not properly set.&#x27;);
            
            var model = null;
            
            try{
                switch(config.adapter){
                    case &#x27;sequelize&#x27;:
                        &#x2F;&#x2F; get model definition
                        var local = require(path.resolve(__dirname+&#x27;&#x2F;..&#x2F;..&#x2F;src&#x2F;models&#x2F;&#x27;+modelName));
                        var modelName = local.model &amp;&amp; local.model.name !== &#x27;undefined&#x27; ? local.model.name : modelName;
                        
                        var ormFields = {}, ormMethods = {
                            instanceMethods:{},
                            classMethods:{}
                        };
                        
                        &#x2F;&#x2F; convert to sequelize model
                        if(local.model &amp;&amp; typeof local.model.fields !== &#x27;undefined&#x27;){
                            local.model.fields.forEach(function(f){
                                &#x2F;&#x2F; set sequelize type
                                var ormType = seq[f.type.toUpperCase()];
                                
                                ormFields[f.name] = {
                                    allowNull : !f.required,
                                    primaryKey : typeof f.primary !== &#x27;undefined&#x27;?f.primary:false,
                                    type : ormType
                                }
                                &#x2F;&#x2F; copy min&#x2F;max values
                                if(typeof f.max!== &#x27;undefined&#x27;)
                                    ormFields[f.name].max = f.max
                                if(typeof f.min!== &#x27;undefined&#x27;)
                                    ormFields[f.name].min = f.min
                            });
                            
                            &#x2F;&#x2F; set user defined methods
                            if(local.model &amp;&amp; typeof local.model.methods !== &#x27;undefined&#x27;){
                                Object.keys(local.model.methods).forEach(function(m){
                                    if(&#x2F;^\$.*$&#x2F;g.test(m)){
                                        ormMethods.instanceMethods[m] = local.model.methods[m];
                                    }else{
                                        ormMethods.classMethods[m] = local.model.methods[m];
                                    }
                                });
                            }
                            
                            model = _instance.define(modelName, ormFields, ormMethods);
                        }
                        
                        &#x2F;&#x2F; define custom attributes
                        model._customFields = {};
                        Object.keys(local.model).forEach(function(a){
                            if(!(&#x2F;^(?:fields|relations|methods)$&#x2F;g.test(a))){
                                model._customFields[a] = local.model[a];
                            }
                        });
                            
                        &#x2F;&#x2F; copy relationships from local to orm model
                        model._customRelationships = {};
                        if(local.model &amp;&amp; typeof local.model.relations !== &#x27;undefined&#x27;){
                            Object.keys(local.model.relations).forEach(function(rel){
                                model._customRelationships[rel] = local.model.relations[rel];
                            });
                        }
                            
                        return model;
                        break;
                }
            }catch(e){
                console.trace(e)
            }
            
            return model;
        },
        &#x2F;**
         * This will convert the provided ORM model&#x27;s instance into a  
         * baseModel instance.
         * 
         * @param   {Object}    ORM. ORM&#x27;s specific model instance.
         * @param   {Object}    Base. model&#x27;s instance.
         * @param   {Array}     With. names of related models to be attached to the 
         *                      returned model.
         * @method getLocalModelFromORM
         * @return  {Object}    This framework&#x27;s compatible model.
         *&#x2F;
        getLocalModelFromORM : function(ormModel, baseModel, _with){
            &#x2F;&#x2F; convert to base model
            var base = typeof baseModel !== &#x27;undefined&#x27; ? baseModel :require(path.resolve(__dirname+&#x27;&#x2F;..&#x2F;models&#x2F;baseModel&#x27;))(ormModel);
            var model = base;
            var modelName = null;

            &#x2F;&#x2F; merge own instance with user methods and settings defined in ORM model.
            switch(config.adapter){
                case &#x27;sequelize&#x27;:
                    var opts = ormModel.options ? ormModel.options : ormModel.__options;
                    model = Object.merge(base, opts.instanceMethods);
                    model = Object.merge(model, opts.classMethods);
                    modelName = typeof baseModel !== &#x27;undefined&#x27; ? baseModel.$$name : ormModel.name;
                    break;
            }
            
            &#x2F;&#x2F; if this is an instance of a local model, then delete top class methods&#x2F;properties
            if(typeof baseModel !== &#x27;undefined&#x27;){
                Object.keys(baseModel).forEach(function(k){
                    if(&#x2F;^\$(?:find|create)$&#x2F;g.test(k)){
                        delete model[k]
                    }
                });
            }

            &#x2F;&#x2F; define getter&#x2F;setters
            model.$getFields().forEach(function(f){
                Object.defineProperty(model,f,{
                    get : function(){
                        switch(config.adapter){
                            case &#x27;sequelize&#x27;:
                                return ormModel[f];
                                break;
                        }
                    },
                    set : function(newV){
                        switch(config.adapter){
                            case &#x27;sequelize&#x27;:
                                ormModel[f]= newV;
                                break;
                        }
                    },
                    enumerable : true,
                    configurable : true
                });
            });
            
            &#x2F;&#x2F; set custom fields
            if(typeof ormModel._customFields === &#x27;object&#x27;){
                Object.keys(ormModel._customFields).forEach(function(f){
                    if(typeof ormModel._customFields[f] !== &#x27;function&#x27; &amp;&amp; f!==&#x27;name&#x27;)
                        model[&#x27;$$&#x27;+f] = ormModel._customFields[f];
                });
            }
            
            &#x2F;&#x2F; set model&#x27;s name as readonly attribute
            Object.defineProperty(model, &#x27;$$name&#x27;,{
                value: modelName,
                writable: false,
                configurable: false,
                enumerable: true
            });

            &#x2F;&#x2F; make orm available (for internal purposes only)
            Object.defineProperty(model, &#x27;_ormModel&#x27;,{
                value: ormModel,
                writable: false,
                configurable: false,
                enumerable: false
            });
            
            &#x2F;&#x2F; if baseModel is a live instance, make relations available to final model
            if(typeof baseModel !==&#x27;undefined&#x27; &amp;&amp; typeof _with !== &#x27;undefined&#x27;)
                _defineRelationsGettersAndSetters(_with, model, this);
            
            return model;
        },
    }
}
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
