<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib&#x2F;bootstrap.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/core.html">core</a></li>
            
                <li><a href="..&#x2F;classes/db.html">db</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/core.html">core</a></li>
            
                <li><a href="..&#x2F;modules/db.html">db</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib&#x2F;bootstrap.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
 * Bootstrap module. General setup, routes and environment initialization.
 * 
 * All the application is initialized here.
 * 
 * @todo    Include src&#x2F;bootstrap.js for custom initialization.
 * 
 * You will not likely need to modify this file.
 * 
 * @author Nicolas Iglesias &lt;nicolas@clevertech.biz&gt;
 *&#x2F;

var lib = require(&#x27;.&#x2F;&#x27;)
,path = require(&#x27;path&#x27;)
,routes = require(path.resolve(__dirname+&#x27;&#x2F;..&#x2F;src&#x2F;config&#x2F;routes&#x27;))
,config = require(path.resolve(__dirname+&#x27;&#x2F;..&#x2F;src&#x2F;config&#x2F;main&#x27;))
,layout = require(&#x27;express3-ejs-layout&#x27;)
,auth = require(&#x27;.&#x2F;components&#x2F;auth&#x27;);

&#x2F;**
 * The following is a list of path strings widely accessed by this application.
 *&#x2F;
var pathDefinition = {
    &#x27;public&#x27;:path.resolve(__dirname+&#x27;&#x2F;..&#x2F;public&#x27;),
    &#x27;assets&#x27;:path.resolve(__dirname+&#x27;&#x2F;..&#x2F;src&#x2F;assets&#x27;)
};
exports.pathDefinition = pathDefinition;

exports.init = function(app, express, rest){
    console.log(&#x27;Bootstrapping...&#x27;);
    
    &#x2F;&#x2F; configure app
    app.configure(function(){
        app.set(&#x27;portWww&#x27;, process.env.APP_UNCOMMON_WWW_PORT || process.argv[2] || 3333);
        app.set(&#x27;portRest&#x27;, process.env.APP_UNCOMMON_REST_PORT || process.argv[3] || 3339);
        app.set(&#x27;views&#x27;, path.resolve(__dirname + &#x27;&#x2F;src&#x2F;views&#x27;));
        app.set(&#x27;view engine&#x27;, &#x27;ejs&#x27;);
        app.set(&#x27;layout&#x27;, path.resolve(__dirname+&#x27;&#x2F;..&#x2F;src&#x2F;views&#x2F;layouts&#x2F;main&#x27;));
        app.set(&#x27;params&#x27;,config.main.params);
        app.use(layout);
        app.use(express.compress());
        app.use(express.favicon());
        app.use(express.logger(&#x27;dev&#x27;));
        app.use(express.bodyParser());
        app.use(express.methodOverride());
        app.use(express.cookieParser(config.main.secretKey));
        app.use(express.session());
        app.use(app.router);

        &#x2F;&#x2F; configure restify
        rest.use(require(&#x27;restify&#x27;).bodyParser({
            mapParams: false
        }));
        rest.use(require(&#x27;restify&#x27;).gzipResponse());
        rest.use(require(&#x27;restify&#x27;).acceptParser(rest.acceptable));
        rest.opts(&#x2F;\.*&#x2F;, function (req, res, next) {
            res.header(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);
            res.header(&quot;Access-Control-Allow-Headers&quot;, &quot;X-Requested-With, Content-type&quot;);
            res.header(&#x27;Access-Control-Allow-Methods&#x27;,&#x27;POST,GET,PUT&#x27;);
            res.send(200);
            next();
        });
        rest.use(require(&#x27;restify&#x27;).fullResponse());

        &#x2F;&#x2F; load less-middleware
        app.use(require(&#x27;less-middleware&#x27;)({
            src:pathDefinition[&#x27;assets&#x27;]+&#x27;&#x2F;less&#x27;,
            dest:pathDefinition[&#x27;public&#x27;]+&#x27;&#x2F;css&#x27;,
            compress:true,
            prefix: &#x27;&#x2F;css&#x27;
        }));
        
        &#x2F;&#x2F; initialize auth
        if(typeof config.main.auth===&#x27;object&#x27;){
            app.use(auth().initialize);
        }
        
        &#x2F;&#x2F; allow http access to &#x2F;public
        app.use(express.static(pathDefinition[&#x27;public&#x27;]));
    });
    
    &#x2F;&#x2F; synchronously initialize controllers
    var restControllers = require(&#x27;.&#x2F;controllers&#x2F;rest&#x27;);
    var controllers = require(&#x27;.&#x2F;controllers&#x27;);
    
    restControllers.init(function(){
        controllers.init(function(){
            &#x2F;&#x2F; initialize routes and prepare for listening requests
            routes.main.forEach(function(route){
                if(typeof route.url !== &#x27;undefined&#x27; &amp;&amp; typeof route.action !== &#x27;undefined&#x27;){
                    var target = route.url instanceof Array ? route.url:[route.url];
                    var defAction = &#x27;index&#x27;;
            
                    route.method = route.method || &#x27;get&#x27;;
                    var c = route.action.split(&#x27;&#x2F;&#x27;)[0] || null;
                    var a = route.action.split(&#x27;&#x2F;&#x27;)[1] || defAction;
                    var isRest = route.isRest || false;
            
                    if(c!==null){
                        var cc = !isRest?
                        lib.core.controllers.main[c+&#x27;Controller&#x27;]
                        :lib.core.controllers.rest[c+&#x27;Controller&#x27;];

                        &#x2F;&#x2F; set default action if none is given
                        if(typeof cc === &#x27;undefined&#x27;)
                            cc = {}
                        if(typeof cc[defAction] === &#x27;undefined&#x27;){
                            cc[defAction] = function(req,res){}
                        }

                        switch(route.method){
                            case &#x27;get&#x27;:
                            case &#x27;post&#x27;:
                                target.forEach(function(url){
                                    try{
                                        if(!isRest){
                                            app[route.method](url, function(req, res){
                                                &#x2F;&#x2F; setup method for render
                                                cc.$$.render = function(view,data,cbk){
                                                    var viewFile = null;
                                                    res.locals.auth = req.signedCookies.auth || false;
                                                    
                                                    &#x2F;&#x2F; inject helpers
                                                    res.locals.html = require(&#x27;.&#x2F;helpers&#x2F;html&#x27;);
                                                    
                                                    if(typeof view.layout !== &#x27;undefined&#x27;){
                                                        viewFile = path.resolve(__dirname+&#x27;&#x2F;..&#x2F;src&#x2F;views&#x2F;&#x27;+c+&#x27;&#x2F;&#x27;+view.view);
                                                        layoutFile = path.resolve(__dirname+&#x27;&#x2F;..&#x2F;src&#x2F;views&#x2F;layouts&#x2F;&#x27;+view.layout);
                                                        data.layout = layoutFile;
                                                        res.render(viewFile,data);
                                                    }else{
                                                        viewFile = path.resolve(&#x27;.&#x2F;src&#x2F;views&#x2F;&#x27;+c+&#x27;&#x2F;&#x27;+view);
                                                        res.render(viewFile,data,cbk);
                                                    }
                                                }
                                                cc.$$.app = app;
                                                cc[a](req, res);
                                            });
                                        }else{
                                            var cbk = function(req, res, nxt){
                                                &#x2F;&#x2F; setup method for output
                                                cc.$$.send = function(status, data){
                                                    res.send(status, data);
                                                }
                                                cc[a](req, res, nxt);
                                            };
                                            rest[route.method](url, cbk);
                                        }
                                    }catch(e){
                                        console.trace(e)
                                    }
                                });
                                break;
                            case &#x27;put&#x27;:
                                target.forEach(function(url){
                                    rest.put(url, function(req, res, nxt){
                                        &#x2F;&#x2F; setup method for output
                                        cc.$$.send = function(status, data){
                                            res.send(status, data);
                                        }
                                        cc[a](req, res, nxt);
                                    });
                                });
                                break;
                        }
                    }
                }
            });
            
            &#x2F;&#x2F; rest instance startup
            rest.listen(app.get(&#x27;portRest&#x27;));
        });
    });

}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
