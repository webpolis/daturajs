<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib&#x2F;components&#x2F;auth.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/core.html">core</a></li>
            
                <li><a href="..&#x2F;classes/db.html">db</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/core.html">core</a></li>
            
                <li><a href="..&#x2F;modules/db.html">db</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib&#x2F;components&#x2F;auth.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
 * Basic authentication mechanism.
 * 
 * The Auth Component currently does basically a few things:
 * 
 * When initialized, it will lookup at the settings - src&#x2F;config&#x2F;main.js - and will 
 * listen to any request made to the selected login route - config.loginUrl -.
 * Afterwards, will instantiate the selected model - config.model - and will use 
 * model&#x27;s &#x27;auth&#x27; method to execute custom authentication logic (db lookup, etc).
 * Internally, a cookie is generated - named &#x27;auth&#x27; - containing basic user information.
 * 
 * The configuration parameters are as follow:
 * 
 * loginUrl     - URL receiving POST fields for user information (username, password).
 * @todo logoutUrl    - URL that will clear cookies and redirect the user.
 * 
 * The chosen model must implement &#x27;auth&#x27; method inside model&#x27;s classMethods property (when using Sequelize as the ORM), 
 * so it should be accessible as modelName.auth().
 * The method must return true when succesful or false if authentication has failed.
 * 
 * &#x27;auth&#x27; method&#x27;s signature is:
 * 
 * @param   {Object}    username and password fields, or custom object.
 * @param   {Function}  Callback function to be executed when done. You should pass 
 *                      your user&#x2F;custom object as the argument, which will be set 
 *                      as the &#x27;auth&#x27; cookie. An optional 2nd argument is an array of 
 *                      fields that will be available in the cookie; otherwise, all fields 
 *                      are going to be saved in the &#x27;auth&#x27; cookie (BEWARE! not to show passwords).
 * 
 * @author Nicolas Iglesias &lt;nicolas@clevertech.biz&gt;
 *&#x2F;
var path = require(&#x27;path&#x27;)
,config = require(path.resolve(__dirname+&#x27;&#x2F;..&#x2F;..&#x2F;src&#x2F;config&#x2F;main&#x27;)).main.auth
,db = require(path.resolve(__dirname+&#x27;&#x2F;..&#x2F;adapters&#x2F;db&#x27;));

module.exports = function(){
    return{
        &#x2F;**
         * Listen to login&#x2F;logout requests and provide custom authentication mechanism.
         * 
         * @param   {Object}    Request.
         * @param   {Object}    Response.
         * @param   {Function}  Continue expressjs initialization.
         *&#x2F;
        initialize: function(req, res, nxt){
            &#x2F;&#x2F; listen for login requests
            if(req.originalUrl === config.loginUrl){
                var user = req.body;
                
                if(typeof config.model!==&#x27;undefined&#x27;){
                    &#x2F;&#x2F; instantiate model
                    var ormModel = new db().loadORMModel(config.model.toLowerCase().trim());

                    db().getLocalModelFromORM(ormModel).auth(user,function(user, fields){
                        if(!(user instanceof Array)){
                            var now = new Date();
                            var expireDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1);

                            &#x2F;&#x2F; only keep allowed fields
                            if(typeof fields !== &#x27;undefined&#x27; &amp;&amp; fields.length&gt;0){
                                Object.keys(user).forEach(function(k){
                                    if(fields.indexOf(k)===-1)
                                        delete user[k]
                                })
                            }
                            res.cookie(&#x27;auth&#x27;,user, {
                                expires: expireDate,
                                signed: true
                            });

                            res.send(200, true);
                        }else{
                            res.send(401, false);
                        }
                    });
                    return
                }
            }
            
            if(req.originalUrl === config.logoutUrl){
                res.clearCookie(&#x27;auth&#x27;);
                res.redirect(&#x27;&#x2F;&#x27;);
                return;
            }
            
            nxt();
        }
    }
}
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
