<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib&#x2F;console&#x2F;modelGenerator.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/auth.html">auth</a></li>
            
                <li><a href="..&#x2F;classes/baseModel.html">baseModel</a></li>
            
                <li><a href="..&#x2F;classes/core.html">core</a></li>
            
                <li><a href="..&#x2F;classes/db.html">db</a></li>
            
                <li><a href="..&#x2F;classes/validator.html">validator</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/auth.html">auth</a></li>
            
                <li><a href="..&#x2F;modules/core.html">core</a></li>
            
                <li><a href="..&#x2F;modules/db.html">db</a></li>
            
                <li><a href="..&#x2F;modules/validator.html">validator</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib&#x2F;console&#x2F;modelGenerator.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
 * Generates daturajs models based on provided database schema.
 * At the moment, only supporting Postgresql and Sequelize ORM.
 * 
 * Internally, this script will fetch all tables names using the db configuration 
 * set in src&#x2F;config&#x2F;main.js and will generate a new model in src&#x2F;models for each.
 * 
 * @todo    Obtain foreign indexes and generate appropiate &quot;model association&quot; source code.
 * 
 * ATTENTION! This will overwrite existing models.
 * 
 * @author Nicolas Iglesias &lt;nico@webpolis.com.ar&gt;
 *&#x2F;

var fs = require(&#x27;fs&#x27;)
,pg=require(&#x27;pg&#x27;)
,path = require(&#x27;path&#x27;)
,inflector = require(&#x27;inflector&#x27;)
,seq = require(&#x27;sequelize&#x27;)
,config = require(path.resolve(__dirname+&#x27;&#x2F;..&#x2F;..&#x2F;src&#x2F;config&#x2F;main&#x27;))
,modelName = null;

if(process.argv[2]){
    modelName = process.argv[2].trim().singular();
}

var con = &#x27;tcp:&#x2F;&#x2F;&#x27;
+config.main.db.username
+&#x27;:&#x27;
+config.main.db.password
+&#x27;@&#x27;
+config.main.db.host
+&#x27;&#x2F;&#x27;
+config.main.db.database;

var typeMap = {
    varchar:&#x27;string&#x27;,
    text:&#x27;text&#x27;,
    &#x27;int&#x27;:&#x27;integer&#x27;,
    &#x27;integer&#x27;:&#x27;integer&#x27;,
    timestamp:&#x27;date&#x27;,
    date:&#x27;date&#x27;,
    bool:&#x27;boolean&#x27;,
    tinyint:&#x27;integer&#x27;,
    numeric:&#x27;float&#x27;,
    &#x27;float&#x27;:&#x27;float&#x27;,
    &#x27;double&#x27;:&#x27;float&#x27;
}

&#x2F;&#x2F; set queries
var qc, qt = null;
switch(config.main.db.driver){
    case &#x27;postgres&#x27;:
        qt = &quot;select * from information_schema.tables as t where t.table_catalog = &#x27;&quot;
            +config.main.db.database+&quot;&#x27; &quot;
            +&quot;and t.table_schema = &#x27;public&#x27;&quot;;
        qc = &quot;\
SELECT c.relname as Table, a.attnum, a.attname AS Field, t.typname AS Type, \
    a.attlen AS Length, a.atttypmod AS length_var, \
    a.attnotnull AS Null, a.atthasdef as has_default \
FROM pg_class c, pg_attribute a, pg_type t \
WHERE c.relname = &#x27;$$table&#x27; \
  AND a.attnum &gt; 0 \
  AND a.attrelid = c.oid \
  AND a.atttypid = t.oid \
ORDER BY a.attnum;\
&quot;;
        break;
    case &#x27;mysql&#x27;:
        qt = &#x27;SHOW TABLES FROM &#x27;+config.main.db.database;
        qc = &#x27;SHOW COLUMNS FROM $$table FROM &#x27;+config.main.db.database;
        break;
}

var client = new pg.Client(con);
client.connect(function(err) {
    &#x2F;&#x2F; get tables list
    var tables = []
    var qtt = client.query(qt);
    qtt.on(&#x27;row&#x27;,function(r){
        var o = {};
        o.fileHeader =&quot;\
&#x2F;**\n\
 * &quot;+r.table_name.singular().humanize()+&quot; model.\n\
 *\n\
 * Auto-generated by modelGenerator.\n\
 *\n\
 * @author Nicolas Iglesias &lt;nico@webpolis.com.ar&gt;\n\
 *&#x2F;\n\
&quot;;
        o.fileHeader += &quot;\
var inflector = require(&#x27;inflector&#x27;);\n\
\n\
exports.model = {\
&quot;;
        o.fileBody = &#x27;&#x27;;
        o.queryColumns = qc.replace(&#x2F;\$\$table&#x2F;gi,r.table_name);
        o.fileFooter = &#x27;}&#x27;;
        tables[r.table_name] = o;
    });
    qtt.on(&#x27;end&#x27;,function(){
        for(var t in tables){
            if(modelName!== null &amp;&amp; modelName !== t.singular()) continue;
            
            var qqc = client.query(tables[t].queryColumns);
            qqc.on(&#x27;row&#x27;,function(c){
                if(typeof tables[c.table].columns === &#x27;undefined&#x27;)
                    tables[c.table].columns = [];
                tables[c.table].columns.push(c);
            });
            qqc.on(&#x27;end&#x27;,function(){
                });
        }
        
        setTimeout(function(){
            client.end();
            
            for(tt in tables){
                if(modelName!== null &amp;&amp; modelName !== tt.singular()) continue;
                
                tables[tt].fileBody = &quot;\t&#x2F;&#x2F; access your variables by adding the $$ prefix\n&quot;;
                tables[tt].fileBody += &quot;\tname : &#x27;&quot;+tt.singular()+&quot;&#x27;,\n&quot;;
                tables[tt].fileBody += &quot;\t&#x2F;&#x2F; map your database columns here\n\tfields : [\n&quot;;
                tables[tt].columns.forEach(function(c){
                    var type = &#x2F;int\d+&#x2F;.test(c.Type) ? typeMap[&#x27;int&#x27;] : typeMap[c.Type];
                    var props = [
                    &#x27;name : \&#x27;&#x27;+c.Field+&#x27;\&#x27;&#x27;,
                    &#x27;label : \&#x27;&#x27;+c.Field+&#x27;\&#x27;.humanize()&#x27;,
                    &#x27;type : \&#x27;&#x27;+type+&#x27;\&#x27;&#x27;,
                    &#x27;required : &#x27;+(c.Null?&#x27;false&#x27;:&#x27;true&#x27;)
                    ];
                    
                    if(type === typeMap[&#x27;int&#x27;] &amp;&amp; c.Field === &#x27;id&#x27;)
                        props.push(&#x27;primaryKey : true&#x27;);
                    if(c.length_var!==-1)
                        props.push(&#x27;max : &#x27;+c.Length);
                    
                    tables[tt].fileBody += &#x27;\t\t{&#x27;+props.join(&#x27;, &#x27;)+&#x27;},\n&#x27;;
                });
                tables[tt].fileBody += &#x27;\t],\n&#x27;
                tables[tt].fileBody += &#x27;&#x27;
                +&#x27;\t&#x2F;&#x2F; place your custom model methods below.\n&#x27;
                +&#x27;\tmethods : {\n&#x27;
                +&quot;\t\t$instanceMethod : function(){ console.log(&#x27;Prefix your instance methods\\&#x27; name with a dollar sign ($). Example: model.$instanceMethod()&#x27;);},\n&quot;
                +&quot;\t\tclassMethod : function(){ console.log(&#x27;This class method is accesed statically. Example: this.models.modelName.classMethod()&#x27;);}\n&quot;
                +&#x27;\t},\n&#x27;
                +&#x27;\trelations : {\n&#x27;
                +&#x27;\t\thasOne:[],\n&#x27;
                +&#x27;\t\thasMany:[],\n&#x27;
                +&#x27;\t\tbelongsTo:[],\n&#x27;
                +&#x27;\t}&#x27;;
                
                var content = [
                tables[tt].fileHeader,
                tables[tt].fileBody,
                tables[tt].fileFooter
                ];
                var fname = path.resolve(__dirname+&#x27;&#x2F;..&#x2F;..&#x2F;src&#x2F;models&#x2F;&#x27;+tt.singular().toLowerCase()+&#x27;.js&#x27;);

                console.log(&#x27;Saving &#x27;+tt.singular()+&#x27; model into &#x27;+fname);
                fs.writeFile(fname,content.join(&#x27;\n&#x27;),function(err){
                    if (err) throw err;
                });
            }
        }, 5000);
    });
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
