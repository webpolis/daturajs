<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib&#x2F;models&#x2F;baseModel.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/auth.html">auth</a></li>
            
                <li><a href="..&#x2F;classes/baseModel.html">baseModel</a></li>
            
                <li><a href="..&#x2F;classes/core.html">core</a></li>
            
                <li><a href="..&#x2F;classes/db.html">db</a></li>
            
                <li><a href="..&#x2F;classes/validator.html">validator</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/auth.html">auth</a></li>
            
                <li><a href="..&#x2F;modules/core.html">core</a></li>
            
                <li><a href="..&#x2F;modules/db.html">db</a></li>
            
                <li><a href="..&#x2F;modules/validator.html">validator</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib&#x2F;models&#x2F;baseModel.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var seq = require(&#x27;sequelize&#x27;)
,path = require(&#x27;path&#x27;)
,config = require(path.resolve(__dirname+&#x27;&#x2F;..&#x2F;..&#x2F;src&#x2F;config&#x2F;main&#x27;)).main.db
,db = require(path.resolve(__dirname+&#x27;&#x2F;..&#x2F;adapters&#x2F;db&#x27;))
,lib = require(path.resolve(__dirname+&#x27;&#x2F;..&#x2F;&#x27;));

&#x2F;**
 * @class   baseModel
 *&#x2F;
module.exports = function(ormModel){
    var _ormModel = typeof ormModel.__options !== &#x27;undefined&#x27; ? ormModel:ormModel;
    var _buildQuery = function(ccAnd, ccOr){
        var cc = &#x27;&#x27;;
            
        if(ccAnd.length&gt;0)
            cc += &#x27;(&#x27;+ccAnd.join(&#x27; AND &#x27;)+&#x27;)&#x27;;
        if(ccOr.length&gt;0)
            cc += &#x27;(&#x27;+ccOr.join(&#x27; OR &#x27;)+&#x27;)&#x27;;
                
        return cc;
    }
    
    var model =  Object.create({
        &#x2F;**
         * Gets a new instance of the current model.
         * Optionally define its default attributes.
         *
         * @param   {Object}    Optional. Default attributes for new instance.
         * @param   {Array}     Unimplemented. Optional associated models to be retrieved.
         * @method  getInstance
         * @return  {Object}    The model&#x27;s instance.
         *&#x2F;
        getInstance:function(model, _with){
            var _this = this;
            
            if(typeof model !== &#x27;undefined&#x27;){
                var _ormModel = db().loadORMModel(_this.$$name).build(model);
                _this = db().getLocalModelFromORM(_ormModel, _this);
            }
            
            return _this;
        },
        &#x2F;**
         * Run before saving a model.
         * You can pre-process the attributes here.
         *
         * @method  $beforeSave
         * @param   {Object}    Attributes and its values.
         * @param   {Function}  Execute this callback when you&#x27;re done processing the attributes.
         *                      Pass the modified attributes as the 1st argument.
         *&#x2F;
        $beforeSave : function(attrs, cbk){
            cbk(attrs);
        },
        &#x2F;**
         * Run after a model has been saved.
         *
         * @method  $afterSave
         * @param   {Function}  Execute this callback when you&#x27;re done doing additional processing.
         *&#x2F;
        $afterSave : function(cbk){
            cbk();
        },
        &#x2F;**
         * Run before a finder query is executed.
         * You can pre-process the conditions and options here.
         *
         * @method  $beforeFind
         * @param   {String}    Find method. Can be &#x27;all&#x27;,&#x27;one&#x27;,&#x27;min&#x27;,&#x27;max&#x27; or &#x27;count&#x27;.
         * @param   {Object}    Options to be applied to the final query.
         * @param   {Function}  Execute this callback when you&#x27;re done processing the options.
         *&#x2F;
        $beforeFind : function(findType, options, cbk){
            cbk();
        },
        &#x2F;**
         * Run after a finder query is executed.
         * You can pre-process the resulting data here.
         *
         * @method  $afterFind
         * @param   {Mixed}     Can be array or one object containing results, depending on the find method chosen.
         * @param   {Function}  Execute this callback when you&#x27;re done processing the results.
         *                      Pass the processed results as unique argument.
         *&#x2F;
        $afterFind : function(results, cbk){
            cbk(results);
        },
        &#x2F;**
         * @method  $find
         * @param   {String}    Can be &#x27;all&#x27;, &#x27;one&#x27;, &#x27;min&#x27;, &#x27;max&#x27; or &#x27;count&#x27;
         * @param   {Object}    Additional options. Includes &#x27;with&#x27; (array of related models 
         *                      to be included in returning results), &#x27;conditions&#x27;, &#x27;limit&#x27; and &#x27;offset&#x27;.
         * @param   {Function}  Callback to be executed when done
         *&#x2F;
        $find:function(type, opts, cbk){
            var findAll, cc, findCustom,conds,params,limit,offset,order,fields, _with = null;
            var _this = this;

            &#x2F;&#x2F; map conditions with params
            var _mapConditions = function(c){
                if(&#x2F;\:[\w]+&#x2F;g.test(c) &amp;&amp; (typeof params === &#x27;undefined&#x27; || params.length === 0))
                    throw new Error(&#x27;params were not set&#x27;).stack;
                            
                for(var p in params){
                    c = c.replace(&#x27;:&#x27;+p,typeof params[p]!==&#x27;string&#x27;?
                        params[p]:params[p].replace(&#x2F;\&#x27;&#x2F;g,&#x27;\&#x27;&#x27;));
                }
                            
                return c;
            }
            
            &#x2F;&#x2F; execute beforeFind here. pass type &amp; opts and enclose following in cbk
            this.$beforeFind(type.toLowerCase(), opts, function(){
                &#x2F;&#x2F; initialize options
                if(typeof opts !== &#x27;undefined&#x27; &amp;&amp; opts!==null){
                    conds = opts.conditions ? opts.conditions : conds;
                    params = opts.params ? opts.params : params;
                    limit = opts.limit ? opts.limit : limit;
                    offset = opts.offset ? opts.offset : offset;
                    order = opts.order ? opts.order : order;
                    fields = opts.fields ? opts.fields : fields;
                    _with = opts[&#x27;with&#x27;] ? opts[&#x27;with&#x27;] : null;
                
                    &#x2F;&#x2F; construct query
                    if(typeof conds !== &#x27;undefined&#x27;){
                        var ccAnd = (conds.and || conds instanceof Array ? conds.map(_mapConditions):
                            (conds.and?conds.and.map(_mapConditions):[]));
                        var ccOr = conds.or ? conds.or.map(_mapConditions) : [];
                        cc = _buildQuery(ccAnd, ccOr);
                    }
                }
                if(type === &#x27;one&#x27;) limit = 1
            
                switch(config.adapter){
                    case &#x27;sequelize&#x27;:
                        var o = {
                            where:cc?cc:&#x27;1=1&#x27;,
                            order:order?order:null,
                            attributes:fields?fields:null
                        };
                        
                        findAll = function(t){
                            if(t===&#x27;one&#x27;) o.limit = limit
                            if(_with!==null) o.include = _with
                        
                            &#x2F;&#x2F; refreshes relations
                            _this._ormModel = db().setupRelationships(_this._ormModel);
                        
                            return _this._ormModel.findAll(o).success(function(models){
                                var mm = [];
                                models.forEach(function(m){
                                    if(typeof m.name === &#x27;undefined&#x27;)
                                        m.name = _this._ormModel.name
                                
                                    var model = db().getLocalModelFromORM(m, _this, _with, fields)
                                    mm.push(model);
                                });
                            
                                var ret = t===&#x27;one&#x27; &amp;&amp; mm.length&gt;0?mm[0]:mm;
                            
                                &#x2F;&#x2F; execute afterFind here. pass mm and enclose following in cbk
                                _this.$afterFind(ret, cbk)
                            });
                        }
                    
                        findCustom = function(t){
                            &#x2F;&#x2F; refreshes relations
                            _this._ormModel = db().setupRelationships(_this._ormModel);
                        
                            return _this._ormModel[t](o).success(function(v){
                                &#x2F;&#x2F; execute afterFind here. pass v and enclose following in cbk
                                _this.$afterFind(v, cbk);
                            });
                        }
                        break;
                }
            
                switch(type){
                    case &#x27;one&#x27;:
                    case &#x27;all&#x27;:
                        return findAll(type);
                        break;
                    case &#x27;min&#x27;:
                    case &#x27;max&#x27;:
                    case &#x27;count&#x27;:
                        return findCustom(type);
                        break;
                }
            });
        },
        $update:function(attrs, opts, cbk, errCbk){
            if(this.$$isNewRecord)
                throw new Error(&#x27;No model loaded. Use getInstance() instead.&#x27;).stack;
            
            var _this = this;
            switch(config.adapter){
                case &#x27;sequelize&#x27;:
                    this._ormModel.isNewRecord = false;
                    delete attrs.id
                    
                    &#x2F;&#x2F; execute beforeSave here. 
                    this.$beforeSave(attrs,function(_attrs){
                        _this._ormModel.updateAttributes(_attrs).success(function(_model){
                            &#x2F;&#x2F; execute afterSave here.
                            _this.$afterSave(function(){
                                cbk(db().getLocalModelFromORM(_model));
                            });
                        }).error(typeof errCbk !== &#x27;undefined&#x27;?errCbk:function(err){
                            throw new Error(err).stack;
                        });
                    });
                    break;
            }
        },
        $create:function(attrs, cbk, errCbk){
            if(!this.$$isNewRecord)
                throw new Error(&#x27;A model instantiated via getInstance() cannot execute $create.&#x27;).stack
            
            var _this = this;
            switch(config.adapter){
                case &#x27;sequelize&#x27;:
                    &#x2F;&#x2F; execute beforeSave here. 
                    this.$beforeSave(attrs,function(_attrs){
                        _this._ormModel.create(_attrs).success(function(_model){
                            &#x2F;&#x2F; execute afterSave here.
                            _this.$afterSave(function(){
                                cbk(db().getLocalModelFromORM(_model));
                            });
                        }).error(typeof errCbk !== &#x27;undefined&#x27;?errCbk:function(err){
                            throw new Error(err).stack;
                        });
                    });
                    break;
            }
        },
        $delete:function(cbk){
            switch(config.adapter){
                case &#x27;sequelize&#x27;:
                    _ormModel.destroy().success(cbk).error(function(err){
                        throw new Error(err).stack;
                    });
                    break;
            }   
        },
        $validate:function(){

        },
        $getFields : function(onlyFields){
            switch(config.adapter){
                case &#x27;sequelize&#x27;:
                    if(typeof onlyFields !== &#x27;undefined&#x27; &amp;&amp; onlyFields instanceof Array){
                        var t = []
                        _ormModel._dbFields.forEach(function(f){
                            if(onlyFields.indexOf(f.name)!== -1)
                                t.push(f)
                        })
                        return t;
                    }else
                        return _ormModel._dbFields;
                    break;
            }
        }
    });
    
    return model;
}
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
