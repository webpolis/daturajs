<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: bootstrap.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: bootstrap.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * Bootstrap module. General setup, routes and environment initialization.
 * 
 * All the application is initialized here.
 * 
 * @todo    Include src/bootstrap.js for custom initialization.
 * 
 * You will not likely need to modify this file.
 * 
 * @author Nicolas Iglesias &lt;nico@webpolis.com.ar>
 */

var lib = require('./')
,path = require('path')
,routes = require(path.resolve(__dirname+'/../src/config/routes'))
,config = require(path.resolve(__dirname+'/../src/config/main'))
,layout = require('express3-ejs-layout')
,auth = require('./components/auth');

/**
 * The following is a list of path strings widely accessed by this application.
 */
var pathDefinition = {
    'public':path.resolve(__dirname+'/../public'),
    'assets':path.resolve(__dirname+'/../src/assets')
};
exports.pathDefinition = pathDefinition;

exports.init = function(app, express, rest){
    console.log('Bootstrapping...');
    
    // configure app
    app.configure(function(){
        app.set('portWww', process.env.APP_UNCOMMON_WWW_PORT || process.argv[2] || 3333);
        app.set('portRest', process.env.APP_UNCOMMON_REST_PORT || process.argv[3] || 3339);
        app.set('views', path.resolve(__dirname + '/src/views'));
        app.set('view engine', 'ejs');
        app.set('layout', path.resolve(__dirname+'/../src/views/layouts/main'));
        app.set('vars',config.main.params);
        app.use(layout);
        app.use(express.compress());
        app.use(express.favicon());
        app.use(express.logger('dev'));
        app.use(express.bodyParser());
        app.use(express.methodOverride());
        app.use(express.cookieParser(config.main.secretKey));
        app.use(express.session());
        app.use(app.router);

        if(rest && rest !==null){
            // configure restify
            rest.use(require('restify').bodyParser({
                mapParams: false
            }));
            rest.use(require('restify').gzipResponse());
            rest.use(require('restify').acceptParser(rest.acceptable));
            rest.opts(/\.*/, function (req, res, next) {
                res.header("Access-Control-Allow-Origin", "*");
                res.header("Access-Control-Allow-Headers", "X-Requested-With, Content-type");
                res.header('Access-Control-Allow-Methods','POST,GET,PUT');
                res.send(200);
                next();
            });
            rest.use(require('restify').fullResponse());
        }

        // load less-middleware
        app.use(require('less-middleware')({
            src:pathDefinition['assets']+'/less',
            dest:pathDefinition['public']+'/css',
            compress:true,
            prefix: '/css'
        }));
        
        // initialize auth
        if(typeof config.main.auth==='object'){
            app.use(auth.initialize);
        }
        
        // allow http access to /public
        app.use(express.static(pathDefinition['public']));
    });
    
    // synchronously initialize controllers
    var restControllers = require('./controllers/rest');
    var controllers = require('./controllers');
    
    var _runCbk = function(){
        // initialize routes and prepare for listening requests
        routes.main.forEach(function(route){
            if(typeof route.url !== 'undefined' && typeof route.action !== 'undefined'){
                var target = route.url instanceof Array ? route.url:[route.url];
                var defAction = 'index';
            
                route.method = route.method || 'get';
                var c = route.action.split('/')[0] || null;
                var a = route.action.split('/')[1] || defAction;
                var isRest = route.isRest || false;
            
                if(c!==null){
                    var cc = !isRest?
                    lib.core.controllers.main[c+'Controller']
                    :lib.core.controllers.rest[c+'Controller'];

                    // set default action if none is given
                    if(typeof cc === 'undefined')
                        cc = {}
                    if(typeof cc[defAction] === 'undefined'){
                        cc[defAction] = function(req,res){}
                    }

                    switch(route.method){
                        case 'get':
                        case 'post':
                            target.forEach(function(url){
                                try{
                                    if(!isRest){
                                        app[route.method](url, function(req, res){
                                            // setup method for render
                                            cc.render = function(view,data,cbk){
                                                data = data || {};
                                                var viewFile = null;

                                                // make component accesible to views
                                                res.locals['auth'] = cc.auth !== null ? cc.auth : auth.getInstance();
                                                    
                                                // inject helpers
                                                res.locals = Object.merge(require('./helpers'), res.locals);
                                                    
                                                if(typeof view.layout !== 'undefined'){
                                                    viewFile = path.resolve(__dirname+'/../src/views/'+c+'/'+view.view);
                                                    layoutFile = path.resolve(__dirname+'/../src/views/layouts/'+view.layout);
                                                    data.layout = layoutFile;
                                                    res.render(viewFile,data);
                                                }else{
                                                    viewFile = path.resolve('./src/views/'+c+'/'+view);
                                                    res.render(viewFile,data,cbk);
                                                }
                                            }
                                            cc.app = app;
                                                
                                            // make components available to controller
                                            cc.auth = auth.getInstance();

                                            // set req body to be accessed via data
                                            cc.data = req.body ? req.body : null;
                                            cc.params = req.params ? req.params : null;
                                            cc[a](req, res);
                                        });
                                    }else if(rest && rest !== null){
                                        var cbk = function(req, res, nxt){
                                            // setup method for output
                                            cc.send = function(status, data){
                                                res.send(status, data);
                                            }
                                            // set req body to be accessed via data
                                            cc.data = req.body ? req.body : null;
                                            cc.params = req.params ? req.params : null;
                                            cc[a](req, res, nxt);
                                        };
                                        rest[route.method](url, cbk);
                                    }
                                }catch(e){
                                    console.trace(e)
                                }
                            });
                            break;
                        case 'put':
                            if(rest && rest !== null){
                                target.forEach(function(url){
                                    rest.put(url, function(req, res, nxt){
                                        // setup method for output
                                        cc.send = function(status, data){
                                            res.send(status, data);
                                        }
                                        // set req body to be accessed via data
                                        cc.data = req.body ? req.body : null;
                                        cc.params = req.params ? req.params : null;
                                                
                                        cc[a](req, res, nxt);
                                    });
                                });
                            }
                            break;
                    }
                }
            }
        });
            
        if(rest && rest !== null)
            // rest instance startup
            rest.listen(app.get('portRest'));
    };
    
    // init
    if(rest && rest !== null){
        restControllers.init(function(){
            controllers.init(_runCbk);
        })
    }else{
        controllers.init(_runCbk);
    }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-auth.html">auth</a></li><li><a href="module-core.html">core</a></li><li><a href="module-db.html">db</a></li><li><a href="module-validator.html">validator</a></li></ul><h3>Classes</h3><ul><li><a href="auth.html">auth</a></li><li><a href="baseModel.html">baseModel</a></li><li><a href="global.html#core">core</a></li><li><a href="db.html">db</a></li><li><a href="validator.html">validator</a></li></ul><h3>Global</h3><ul><li><a href="global.html#$afterFind">$afterFind</a></li><li><a href="global.html#$afterSave">$afterSave</a></li><li><a href="global.html#$beforeFind">$beforeFind</a></li><li><a href="global.html#$beforeSave">$beforeSave</a></li><li><a href="global.html#$find">$find</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#getInstance">getInstance</a></li><li><a href="global.html#getLocalModelFromORM">getLocalModelFromORM</a></li><li><a href="global.html#html">html</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#lib">lib</a></li><li><a href="global.html#loadORMModel">loadORMModel</a></li><li><a href="global.html#pathDefinition">pathDefinition</a></li><li><a href="global.html#setupRelationships">setupRelationships</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Fri Feb 22 2013 02:30:13 GMT-0300 (ART)
</footer>

<script> prettyPrint(); </script>
</body>
</html>
